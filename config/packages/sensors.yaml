################################################################################
#
# @author      : Thomas Maxson
# @package     : Sensors
# @description :
#
################################################################################

sensor:
  - platform: version
    name: ha_version_installed
    source: local

  - platform: version
    name: ha_version_latest
    source: container

  - platform: version
    name: ha_version_latest_beta
    source: container
    beta: true

  - platform: filesize
    file_paths:
      - /config/home-assistant.log

  # MariaDB recorder DB size sensor
  - platform: sql
    db_url: !secret recorder_db_url
    queries:
      - name: MariaDB Database Size
        query: >
          SELECT table_schema "database", Round( Sum( data_length + index_length ) / POWER( 1024, 2 ), 1 ) 
          "value" FROM information_schema.tables WHERE table_schema="homeassistant" GROUP BY table_schema;
        column: value
        unit_of_measurement: MB

  # InfluxDB DB size sensor
  - platform: influxdb
    host: !secret influxdb_host
    port: !secret influxdb_port
    username: !secret influxdb_username
    password: !secret influxdb_password
    queries:
      - name: InfluxDB Database Size
        unit_of_measurement: MB
        value_template: "{{ (value | float / 1024 /1024) | round(1) }}"
        group_function: sum
        measurement: '"monitor"."shard"'
        database: _internal
        where: "time > now() - 10s"
        field: diskBytes

  - platform: systemmonitor
    resources:
      - type: last_boot
      - type: ipv4_address
        arg: eth0
      - type: ipv6_address
        arg: eth0
      - type: processor_use
      - type: processor_temperature
      - type: memory_free
      - type: memory_use_percent
      - type: disk_use_percent
        arg: /
      - type: disk_use
      - type: disk_free
      - type: throughput_network_in
        arg: eth0
      - type: throughput_network_out
        arg: eth0

  - platform: version
    name: ha_version_installed
    source: local

  - platform: version
    name: ha_version_latest
    source: container

  - platform: version
    name: ha_version_latest_beta
    source: container
    beta: true

  - platform: template
    sensors:
      custom_fire_tablet_battery_level:
        #device_class: battery
        friendly_name: Battery Level
        unit_of_measurement: "%"
        value_template: >-
          {{ states( 'sensor.fire_tablet_battery_level' ) | int( 'unknown' ) }}
        icon_template: >-
          {%- set battery_level = states( 'sensor.fire_tablet_battery_level' ) | int( 'unknown' ) -%}
          {%- set battery_round = ( battery_level | int / 10 ) | int * 10 -%}

          {%- if battery_level == 'unknown' -%}
            mdi:battery-unknown

          {%- else -%}
            {%- if battery_round >= 80 -%}
              mdi:battery

            {%- elif battery_round <= 20 -%}
              mdi:battery-outline

            {%- elif battery_round > 0 -%}
              mdi:battery-{{ battery_round }}

            {%- else -%}
              mdi:battery-alert

            {%- endif -%}
          {%- endif -%}

  - platform: template
    sensors:
      doorbell_motion_snooze_countdown:
        device_class: timestamp
        value_template: >-
          {%- set duration = state_attr( 'timer.doorbell_motion_snooze', 'duration' ) %}
          {% set h, m, s = duration.split(':') | list | map('int') %}
          {% set n = now().timestamp()  %}
          {{ (n + h * 60 * 60 + m * 60 + s) | timestamp_custom('%Y-%m-%dT%H:%M:%S-00:00', False) }}

  - platform: template
    sensors:
      # Home Assistant System Entity Item
      ha_version:
        icon_template: mdi:home-assistant
        friendly_name_template: >-
          Installed {{ states( 'sensor.ha_version_installed' ) }}
        value_template: >-
          {{ 'Latest' if states( 'sensor.ha_version_installed' ) == 
          states( 'sensor.ha_version_latest' ) else states( 'sensor.ha_version_latest' ) }}

      fire_tablet_last_app_start_formatted:
        #device_class: timestamp
        friendly_name: Last App Restart
        icon_template: mdi:clock-outline
        value_template: >
          {% set timestamp = states.sensor.fire_tablet_last_app_start.last_updated %}

          {{ relative_time( timestamp ) }}

      fire_tablet_ram_used_memory:
        icon_template: mdi:memory
        unit_of_measurement: GB
        value_template: >-
          {%- set total_memory = states( 'sensor.fire_tablet_ram_total_memory' ) | int -%}
          {%- set free_memory = states( 'sensor.fire_tablet_ram_free_memory' ) | int -%}
          {%- set used_memory = ( total_memory - free_memory ) -%}

          {{ used_memory / total_memory * 100 }}

      # Count interior lights switched ON
      total_lights_on:
        friendly_name: Total Lights On
        icon_template: mdi:lightbulb
        value_template: >-
          {% set state = 'on' %}
          {% set ns = namespace( count = 0 ) %}

          {% for light in state_attr( 'group.lights_all', 'entity_id' ) if is_state( light, state ) %}
            {% set ns.count = ns.count + 1 %}
          {% endfor %}

          {{ ns.count | int }}

      # Count Doors that are OPEN
      total_doors_open:
        friendly_name: Total Doors Open
        icon_template: mdi:door-open
        value_template: >-
          {% set state = 'on' %}
          {% set device = 'door' %}
          {{ states.binary_sensor 
            | selectattr( 'attributes.device_class', 'eq', device ) 
            | selectattr( 'state', 'eq', state ) 
            | list | length }}

  # https://www.egglec.com.au/post/fully-kiosk-browser-and-home-assistant
  - platform: rest
    name: Kitchen Tablet
    resource: !secret rest_url_kiosk_device_info
    json_attributes:
      # - screenOn
      # - batteryLevel
      # - kioskMode
      # - screenBrightness
      # - motionDetectorState
      # - maintenanceMode
      # - appFreeMemory
      # - appUsedMemory
      # - totalFreeMemory
      # - totalUsedMemory
      # - hostname4
      # - ip4
      # - mac
      # - locationLatitude
      # - locationLongitude
      # - locationAltitude
      # - startUrl
      # - currentPage
      - androidSdk
      - androidVersion
      - appFreeMemory
      - appUsedMemory
      - appVersionCode
      - appVersionName
      - batteryLevel
      - currentFragment
      - currentPage
      - currentTabIndex
      - deviceID
      - deviceManufacturer
      - deviceModel
      - deviceName
      - displayHeightPixels
      - displayWidthPixels
      - foregroundApp
      - hostname4
      - hostname6
      - ip4
      - ip6
      - isDeviceAdmin
      - isDeviceOwner
      - isLicensed
      - isScreenOn
      - keyguardLocked
      - kioskLocked
      - kioskMode
      - lastAppStart
      - mac
      - maintenanceMode
      - motionDetectorState
      - plugged
      - screenBrightness
      - screenOrientation
      - ssid
      - startUrl
      - totalFreeMemory
      - totalUsedMemory
      - webviewUa
      - wifiSignalLevel
    value_template: "{{ value_json.isScreenOn }}"
    scan_interval: 10

  - platform: rest
    name: Kitchen Tablet Settings
    json_attributes:
      - timeToScreenOffV2
      - screenBrightness
      - motionSensitivity
      - motionDection
      - motionDetectionAcoustic
      - motionSensitivityAcoustic
      - screenOffInDarkness
      - darknessLevel
    resource: !secret rest_url_kiosk_device_settings
    value_template: "{{ value_json.motionSensitivity }}"
    scan_interval: 10

  - platform: rest
    name: Countdown to Wedding Anniversary
    resource: !secret wolframalpha_api_countdown_wedding_anniversary
    value_template: "{{ (value|replace(' days', '')) }}"
    unit_of_measurement: Days
    scan_interval: 43200

  - platform: rest
    name: Countdown to Mothers Day
    resource: !secret wolframalpha_api_countdown_mothersday
    value_template: "{{ (value|replace(' days', '')) | int }}"
    unit_of_measurement: Days
    scan_interval: 43200

  - platform: rest
    name: Countdown to Fathers day
    resource: !secret wolframalpha_api_countdown_fathersday
    value_template: "{{ (value|replace(' days', '')) | int }}"
    unit_of_measurement: Days
    scan_interval: 43200

  - platform: rest
    name: Countdown to Easter
    resource: !secret wolframalpha_api_countdown_easter
    value_template: "{{ (value|replace(' days', '')) | int }}"
    unit_of_measurement: Days
    scan_interval: 43200

  - platform: rest
    name: Countdown to Halloween
    resource: !secret wolframalpha_api_countdown_halloween
    value_template: "{{ (value|replace(' days', '')) | int }}"
    unit_of_measurement: Days
    scan_interval: 43200

  - platform: rest
    name: Countdown to Thanksgiving
    resource: !secret wolframalpha_api_countdown_thanksgiving
    value_template: "{{ (value|replace(' days', '')) | int }}"
    unit_of_measurement: Days
    scan_interval: 43200

  - platform: rest
    name: Countdown to Christmas
    resource: !secret wolframalpha_api_countdown_christmas
    value_template: "{{ (value|replace(' days', '')) | int }}"
    unit_of_measurement: Days
    scan_interval: 43200

  - platform: template
    sensors:
      is_week_even:
        friendly_name: "Is Week Even"
        value_template: >-
          {%- set output = ( ( ( now().strftime( '%W' ) ) | int ) % 2 ) == 0 %}

          {{ iif( ( True == output ), 'on', 'off' ) }}
        icon_template: >-
          {%- set output = ( ( ( now().strftime( '%W' ) ) | int ) % 2 ) == 0 %}

          {{ iif( ( True == output ), 'mdi:calendar-check', 'mdi:calendar-remove' ) }}

      is_week_odd:
        friendly_name: "Is Week Odd"
        value_template: >-
          {%- set output = ( ( ( now().strftime( '%W' ) ) | int ) % 2 ) == 1 %}

          {{ iif( ( True == output ), 'on', 'off' ) }}
        icon_template: >-
          {%- set output = ( ( ( now().strftime( '%W' ) ) | int ) % 2 ) == 1 %}

          {{ iif( ( True == output ), 'mdi:calendar-check', 'mdi:calendar-remove' ) }}

      # fourth_wednesday:
      #   friendly_name:"Is Fourth Wednesday"
      #   value_template: >
      #     {% set nth = 4 %}
      #     {% set month = now().month %}
      #     {% set isoweekday = 3 %}
      #     {% set d = now().date().replace( month = month ).replace( day = 1 ) %}
      #     {% set adj = ( isoweekday - d.isoweekday() ) % 7 %}

      #     {{ d + timedelta( days = adj ) + timedelta( weeks = nth - 1 ) }}
      #   icon_template: mdi:calendar-question

      custom_door_closet_hallway_j:
        friendly_name: "Jess' Closet Door"
        value_template: >-
          {%- if is_state( 'binary_sensor.door_closet_hallway_j', 'on' ) -%}
            Open
          {%- elif is_state( 'binary_sensor.door_closet_hallway_j', 'off' ) -%}
            Closed
          {%- else -%}
            Unknown
          {%- endif -%}
        icon_template: >-
          {%- if is_state( 'binary_sensor.door_closet_hallway_j', 'on' ) -%}
          mdi:door-sliding-open
          {%- elif is_state( 'binary_sensor.door_closet_hallway_j', 'off' ) -%}
          mdi:door-sliding
          {%- else -%}
          mdi:cloud-question
          {%- endif -%}

      custom_door_closet_hallway_t:
        friendly_name: "Tom's Closet Door"
        value_template: >-
          {%- if is_state( 'binary_sensor.door_closet_hallway_t', 'on' ) -%}
            Open
          {%- elif is_state( 'binary_sensor.door_closet_hallway_t', 'off' ) -%}
            Closed
          {%- else -%}
            Unknown
          {%- endif -%}
        icon_template: >-
          {%- if is_state( 'binary_sensor.door_closet_hallway_t', 'on' ) -%}
          mdi:door-sliding-open
          {%- elif is_state( 'binary_sensor.door_closet_hallway_t', 'off' ) -%}
          mdi:door-sliding
          {%- else -%}
          mdi:cloud-question
          {%- endif -%}
